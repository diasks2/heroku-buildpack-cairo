#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e # fail fast

# parse params
BUILD_DIR=$1
CACHE_DIR=$2

# config
S3_BUCKET="mecab"

function vendor_binary() {
  binary="$1"
  path="$2"
  include="$3"

  echo "       Fetching $binary"
  echo $path
  mkdir -p $path
  package="https://s3.amazonaws.com/$S3_BUCKET/$binary"
  curl $package -s -o - | tar xz -C $path -f -
  
  echo "       Exporting $binary build and include paths"

  export CPPPATH="$path/$include:$CPPPATH"
  export CPATH="$path/$include:$CPATH"
  export LIBRARY_PATH="$path/lib:$LIBRARY_PATH"
  export PKG_CONFIG_PATH="$path/lib/pkgconfig:$PKG_CONFIG_PATH"
  export CFLAGS="-I$path/$include:$CFLAGS"
  export PATH="$path/bin:$PATH"
  export LDFLAGS="-L$path/lib $LDFLAGS"
}

echo "-----> Vendoring binaries"
vendor_binary "libmecab-heroku.tar.gz" "$1/tmp/mecab" "include"
vendor_binary "libmecab-heroku.tar.gz" "/tmp/mecab" "include"

echo "-----> Moving mecab-config to PATH"
cp /tmp/mecab/bin/mecab /app/bin/mecab
cp /tmp/mecab/bin/mecab-config /app/bin/mecab-config

gem install mecab
